const CropsToCode = {
    "Ajwan": "137",
    "Alasande Gram": "281",
    "Almond(Badam)": "325",
    "Alsandikai": "166",
    "Amaranthus": "86",
    "Ambada Seed": "130",
    "Amla(Nelli Kai)": "355",
    "Amphophalus": "102",
    "Antawala": "209",
    "Anthorium": "379",
    "Apple": "17",
    "Apricot(Jardalu/Khumani)": "326",
    "Arecanut(Betelnut/Supari)": "140",
    "Arhar (Tur/Red Gram)(Whole)": "49",
    "Arhar Dal(Tur Dal)": "260",
    "Ashgourd": "83",
    "Astera": "232",
    "Avare Dal": "269",
    "Bajra(Pearl Millet/Cumbu)": "28",
    "Balekai": "274",
    "Bamboo": "204",
    "Banana": "19",
    "Banana - Green": "90",
    "Barley (Jau)": "29",
    "Bay leaf (Tejpatta)": "321",
    "Beans": "94",
    "Beaten Rice": "262",
    "Beetroot": "157",
    "Bengal Gram Dal (Chana Dal)": "263",
    "Bengal Gram(Gram)(Whole)": "6",
    "Ber(Zizyphus/Borehannu)": "357",
    "Betal Leaves": "143",
    "Betelnuts": "41",
    "Bhindi(Ladies Finger)": "85",
    "Big Gram": "113",
    "Binoula": "51",
    "Bitter gourd": "81",
    "Black Gram (Urd Beans)(Whole)": "8",
    "Black Gram Dal (Urd Dal)": "264",
    "Black pepper": "38",
    "BOP": "380",
    "Borehannu": "189",
    "Bottle gourd": "82",
    "Bran": "290",
    "Brinjal": "35",
    "Broken Rice": "293",
    "Broomstick(Flower Broom)": "320",
    "Bull": "214",
    "Bullar": "284",
    "Bunch Beans": "224",
    "Butter": "272",
    "Cabbage": "154",
    "Calf": "215",
    "Camel Hair": "354",
    "Cane": "205",
    "Capsicum": "164",
    "Cardamoms": "40",
    "Carnation": "375",
    "Carrot": "153",
    "Cashew Kernnel": "238",
    "Cashewnuts": "133",
    "Cashewnuts": "36",
    "Castor Oil": "270",
    "Castor Seed": "123",
    "Cauliflower": "34",
    "Chakotha": "188",
    "Chapparad Avare": "169",
    "Chennangi (Whole)": "241",
    "Chennangi Dal": "295",
    "Cherry": "328",
    "Chikoos(Sapota)": "71",
    "Chili Red": "26",
    "Chilly Capsicum": "88",
    "Chow Chow": "167",
    "Chrysanthemum": "402",
    "Chrysanthemum(Loose)": "231",
    "Cinamon(Dalchini)": "316",
    "Cloves": "105",
    "Cluster beans": "80",
    "Coca": "315",
    "Cock": "368",
    "Cocoa": "104",
    "Coconut": "138",
    "Coconut": "37",
    "Coconut Oil": "266",
    "Coconut Seed": "112",
    "Coffee": "45",
    "Colacasia": "318",
    "Copra": "129",
    "Coriander(Leaves)": "43",
    "Corriander seed": "108",
    "Cotton": "15",
    "Cotton Seed": "99",
    "Cow": "212",
    "Cowpea (Lobia/Karamani)": "92",
    "Cowpea(Veg)": "89",
    "Cucumbar(Kheera)": "159",
    "Cummin Seed(Jeera)": "42",
    "Custard Apple (Sharifa)": "352",
    "Daila(Chandni)": "382",
    "Dal (Avare)": "91",
    "Dalda": "273",
    "Delha": "410",
    "Dhaincha": "69",
    "Drumstick": "168",
    "Dry Chillies": "132",
    "Dry Fodder": "345",
    "Dry Grapes": "278",
    "Duck": "370",
    "Duster Beans": "163",
    "Egg": "367",
    "Egypian Clover(Barseem)": "361",
    "Elephant Yam (Suran)": "296",
    "Field Pea": "64",
    "Fig(Anjura/Anjeer)": "221",
    "Firewood": "206",
    "Fish": "366",
    "Flower Broom": "365",
    "Foxtail Millet(Navane)": "121",
    "French Beans (Frasbean)": "298",
    "Galgal(Lemon)": "350",
    "Garlic": "25",
    "Ghee": "249",
    "Gingelly Oil": "276",
    "Ginger(Dry)": "27",
    "Ginger(Green)": "103",
    "Gladiolus Bulb": "364",
    "Gladiolus Cut Flower": "363",
    "Goat": "219",
    "Goat Hair": "353",
    "Gram Raw(Chholia)": "359",
    "Gramflour": "294",
    "Grapes": "22",
    "Green Avare (W)": "165",
    "Green Chilli": "87",
    "Green Fodder": "346",
    "Green Gram (Moong)(Whole)": "9",
    "Green Gram Dal (Moong Dal)": "265",
    "Green Peas": "50",
    "Ground Nut Oil": "267",
    "Ground Nut Seed": "268",
    "Groundnut": "10",
    "Groundnut (Split)": "314",
    "Groundnut pods (raw)": "312",
    "Guar": "75",
    "Guar Seed(Cluster Beans Seed)": "413",
    "Guava": "185",
    "Gur(Jaggery)": "74",
    "Gurellu": "279",
    "Haralekai": "252",
    "He Buffalo": "216",
    "Hen": "369",
    "Hippe Seed": "125",
    "Honey": "236",
    "Honge seed": "124",
    "Hybrid Cumbu": "119",
    "Indian Beans (Seam)": "299",
    "Indian Colza(Sarson)": "344",
    "Isabgul (Psyllium)": "256",
    "Jack Fruit": "182",
    "Jaffri": "406",
    "Jaggery": "151",
    "Jamamkhan": "175",
    "Jamun(Narale Hannu)": "184",
    "Jarbara": "376",
    "Jasmine": "229",
    "Javi": "250",
    "Jowar(Sorghum)": "5",
    "Jute": "16",
    "Jute Seed": "210",
    "Kabuli Chana(Chickpeas-White)": "362",
    "Kacholam": "317",
    "Kakada": "230",
    "Kankambra": "233",
    "Karamani": "115",
    "Karbuja(Musk Melon)": "187",
    "Kartali (Kantola)": "305",
    "Kharif Mash": "61",
    "Khoya": "372",
    "Kinnow": "336",
    "Knool Khol": "177",
    "Kodo Millet(Varagu)": "117",
    "Kuchur": "243",
    "Kulthi(Horse Gram)": "114",
    "Ladies Finger": "155",
    "Lak(Teora)": "96",
    "Leafy Vegetable": "171",
    "Lemon": "310",
    "Lentil (Masur)(Whole)": "63",
    "Lilly": "378",
    "Lime": "180",
    "Linseed": "67",
    "Lint": "280",
    "Litchi": "351",
    "Little gourd (Kundru)": "302",
    "Long Melon(Kakri)": "304",
    "Lotus": "403",
    "Lotus Sticks": "339",
    "Lukad": "337",
    "Mace": "107",
    "Mahedi": "411",
    "Mahua": "335",
    "Mahua Seed(Hippe seed)": "371",
    "Maida Atta": "288",
    "Maize": "4",
    "Mango": "20",
    "Mango (Raw-Ripe)": "172",
    "Maragensu": "225",
    "Marasebu": "181",
    "Marget": "407",
    "Marigold(Calcutta)": "235",
    "Marigold(loose)": "405",
    "Mash": "60",
    "Mashrooms": "340",
    "Masur Dal": "259",
    "Mataki": "93",
    "Methi Seeds": "47",
    "Methi(Leaves)": "46",
    "Millets": "237",
    "Mint(Pudina)": "360",
    "Moath Dal": "258",
    "Moath Dal": "95",
    "Mousambi(Sweet Lime)": "77",
    "Mustard": "12",
    "Mustard Oil": "324",
    "Myrobolan(Harad)": "142",
    "Nargasi": "245",
    "Nearle Hannu": "222",
    "Neem Seed": "126",
    "Nelli Kai": "223",
    "Niger Seed (Ramtil)": "98",
    "Nutmeg": "106",
    "Onion": "23",
    "Onion Green": "358",
    "Orange": "18",
    "Orchid": "381",
    "Other Pulses": "97",
    "Ox": "213",
    "Paddy(Dhan)(Basmati)": "414",
    "Paddy(Dhan)(Common)": "2",
    "Papaya": "72",
    "Papaya (Raw)": "313",
    "Patti Calcutta": "404",
    "Peach": "331",
    "Pear(Marasebu)": "330",
    "Peas cod": "308",
    "Peas Wet": "174",
    "Peas(Dry)": "347",
    "Pegeon Pea (Arhar Fali)": "301",
    "Pepper garbled": "109",
    "Pepper ungarbled": "110",
    "Persimon(Japani Fal)": "327",
    "Pigs": "220",
    "Pineapple": "21",
    "Plum": "329",
    "Pointed gourd (Parval)": "303",
    "Polherb": "240",
    "Pomegranate": "190",
    "Potato": "24",
    "Pumpkin": "84",
    "Pundi": "254",
    "Pundi Seed": "128",
    "Raddish": "161",
    "Ragi (Finger Millet)": "30",
    "Raibel": "409",
    "Rajgir": "248",
    "Ram": "282",
    "Rat Tail Radish (Mogari)": "307",
    "Raya": "65",
    "Red Gram": "7",
    "Resinwood": "322",
    "Riccbcan": "62",
    "Rice": "3",
    "Ridge gourd(Tori)": "160",
    "Rose(Local)": "374",
    "Rose(Loose)": "228",
    "Rose(Tata)": "373",
    "Round gourd": "306",
    "Rubber": "111",
    "Sabu Dana": "291",
    "Safflower": "59",
    "Saffron": "338",
    "Sajje": "271",
    "Same/Savi": "122",
    "Sarasum": "247",
    "Season Leaves": "277",
    "Seegu": "253",
    "Seemebadnekai": "176",
    "Seetafal": "201",
    "Sesamum(Sesame,Gingelly,Til)": "11",
    "She Buffalo": "217",
    "She Goat": "283",
    "Sheep": "218",
    "Siddota": "183",
    "Skin And Hide": "226",
    "Snake gourd": "156",
    "Soanf": "135",
    "Soapnut(Antawala/Retha)": "207",
    "Soji": "286",
    "Sompu": "246",
    "Soyabean": "13",
    "Spinach": "342",
    "Sponge gourd": "311",
    "Squash(Chappal Kadoo)": "332",
    "Sugar": "48",
    "Sugarcane": "150",
    "Sunflower": "14",
    "Sunflower Seed": "285",
    "Sunhemp": "139",
    "Suram": "242",
    "Surat Beans (Papadi)": "300",
    "Suva (Dill Seed)": "255",
    "Suvarna Gadde": "178",
    "Sweet Potato": "152",
    "Sweet Pumpkin": "173",
    "T.V. Cumbu": "120",
    "Tamarind Fruit": "261",
    "Tamarind Seed": "208",
    "Tapioca": "100",
    "Taramira": "76",
    "Tea": "44",
    "Tender Coconut": "200",
    "Thinai (Italian Millet)": "116",
    "Thogrikai": "170",
    "Thondekai": "162",
    "Tinda": "349",
    "Tobacco": "141",
    "Tomato": "78",
    "Torchwood": "323",
    "Toria": "66",
    "Tube Flower": "234",
    "Tube Rose(Double)": "401",
    "Tube Rose(Loose)": "408",
    "Tube Rose(Single)": "377",
    "Turmeric": "39",
    "Turmeric (raw)": "309",
    "Turnip": "341",
    "Walnut": "343",
    "Water Melon": "73",
    "Wheat": "1",
    "Wheat Atta": "287",
    "White Peas": "412",
    "White Pumpkin": "158",
    "Wood": "203",
    "Wool": "348",
    "Yam": "244",
    "Yam (Ratalu)": "297"
}

const StatesToCode = {
    "Andaman and Nicobar": "AN",
    "Andhra Pradesh": "AP",
    "Arunachal Pradesh": "AR",
    "Assam": "AS",
    "Bihar": "BI",
    "Chandigarh": "CH",
    "Chattisgarh": "CG",
    "Dadra and Nagar Haveli": "DN",
    "Daman and Diu": "DD",
    "Goa": "GO",
    "Gujarat": "GJ",
    "Haryana": "HR",
    "Himachal Pradesh": "HP",
    "Jammu and Kashmir": "JK",
    "Jharkhand": "JR",
    "Karnataka": "KK",
    "Kerala": "KL",
    "Lakshadweep": "LD",
    "Madhya Pradesh": "MP",
    "Maharashtra": "MH",
    "Manipur": "MN",
    "Meghalaya": "MG",
    "Mizoram": "MZ",
    "Nagaland": "NG",
    "NCT of Delhi": "DL",
    "Odisha": "OR",
    "Pondicherry": "PC",
    "Punjab": "PB",
    "Rajasthan": "RJ",
    "Sikkim": "SK",
    "Tamil Nadu": "TN",
    "Telangana": "TL",
    "Tripura": "TR",
    "Uttar Pradesh": "UP",
    "Uttrakhand": "UC",
    "West Bengal": "WB"
}

function makeReverseMap(obj) {
    let output = {};
    for (let key of Object.keys(obj)) {
        let value = obj[key];
        output[value] = key;
    }
    return output;
}

const CodeToCrops = makeReverseMap(CropsToCode);
const CodeToStates = makeReverseMap(StatesToCode);
const MESSAGE_TYPES = {
    "SET_STATE": "SET_STATE",
    "SET_COMMODITY": "SET_COMMODITY",
    "RELOAD_PAGE": "RELOAD_PAGE",
    "EXPAND_MARKETS": "EXPAND_MARKETS",
    "MARKETS_EXPANDED": "MARKETS_EXPANDED",
    "DOWNLOAD_EXCEL": "DOWNLOAD_EXCEL",
    "PAGE_LOADED": "PAGE_LOADED",
    "START": "START",
    "STOP": "STOP",
}

const MESSAGE_CLIENTS = {
    "BACKGROUND": "BACKGROUND",
    "CONTENT": "CONTENT",
    "POPUP": "POPUP"
}

class Message {
    constructor() {
        this.type = null;
        this.sender = null;
        this.reciever = null;
        this.data = null;
    }
}

function createPromise() {
    let res, rej;
    let p = new Promise((resolve, reject) => {
        res = resolve;
        rej = reject
    })
    p.resolve = res;
    p.reject = rej;
    return p;
}

function sendMessage(message) {
    console.log("sending message", message);
    if (WHAT_AM_I == MESSAGE_CLIENTS.BACKGROUND) {
        chrome.tabs.query({ active: true }, function (tabs) {
            console.log(tabs);
            for (let tab of tabs) {
                if (tab.url.startsWith("https://agmarknet.gov.in")) {
                    console.log("sending to tab", tab)
                    chrome.tabs.sendMessage(tab.id, message);
                    break;
                }
            }
        });
    } else {
        chrome.runtime.sendMessage(message);
    }
}

function setUpMessageListeners() {
    chrome.runtime.onMessage.addListener((message) => {
        console.log("got message", message);
        const { type, data, sender, reciever } = message;
        if (reciever != WHAT_AM_I)
            return;
        switch (type) {
            case "SET_STATE":
                break;
            case "SET_COMMODITY":
                break;
            case MESSAGE_TYPES.START:
                startAutomation(data);
                break;
            case MESSAGE_TYPES.STOP:
                stopAutomation();
                break;
            case MESSAGE_TYPES.RELOAD_PAGE:
                onReloadPageEvent(data);
                break;
            case MESSAGE_TYPES.PAGE_LOADED:
                onPageLoadedEvent(data);
                break;
            case MESSAGE_TYPES.EXPAND_MARKETS:
                onExpandMarketsEvent();
                break;
            case MESSAGE_TYPES.MARKETS_EXPANDED:
                sendDownloadExcelEvent(data);
                break;
            case MESSAGE_TYPES.DOWNLOAD_EXCEL:
                clickExcelButton();
                break;
        }
    });
}

// POPUP Functions
function onStartButtonClicked(selectedCrop) {
    let message = {
        type: MESSAGE_TYPES.START,
        reciever: MESSAGE_CLIENTS.BACKGROUND,
        sender: MESSAGE_CLIENTS.POPUP,
        data: {
            crops: [selectedCrop]
        }
    }

    sendMessage(message);
}
///CONTENT FUNCTIONS
function onReloadPageEvent(data) {
    var { commodity, state, fromDate, toDate } = data;
    let goBtn = document.getElementById("btnGo")

    let commoditySelector = document.getElementById("ddlCommodity");
    let stateSelector = document.getElementById("ddlState");
    let fromDateSelector = document.getElementById("txtDate");
    let toDateSelector = document.getElementById("txtDateTo");

    stateSelector.value = state;
    commoditySelector.value = commodity;
    fromDateSelector.value = fromDate;
    toDateSelector.value = toDate;
    goBtn.click();
}

async function onExpandMarketsEvent() {

    async function wait(time) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                resolve()
            }, time)
        });
    }
    var districtExpandBtn = document.getElementById("cphBody_GridArrivalData_imgOrdersShow_0")
    if (!districtExpandBtn) {
        console.log(`There is no data`);
        let message = {
            type: MESSAGE_TYPES.MARKETS_EXPANDED,
            reciever: MESSAGE_CLIENTS.BACKGROUND,
            sender: MESSAGE_CLIENTS.CONTENT
        }
        sendMessage(message);
        return;
    }
    console.log("clicking districktExpndbutton");
    districtExpandBtn.click();
    await wait(1000);
    let nodes;
    for (let i = 0; i < 4; i++) {
        nodes = document.querySelectorAll(`[name^="ctl00$cphBody$GridArrivalData$ctl02$gvOrders"]`);
        if (nodes.length) {
            console.log("Got nodes", nodes.length);
            break;
        }
        console.log(i, "waiting for page to finish loading")
        await wait(1000);
    }

    const marketIDPREFIX = "cphBody_GridArrivalData_gvOrders_0_imgProductsShow_";
    for (let counter = 0; counter < nodes.length; counter++) {

        let node = document.getElementById(`${marketIDPREFIX}${counter}`);
        if (node) {
            console.log("clicking plus button", counter);
            node.click();
            await wait(1000);
        }
    }
    let message = {
        type: MESSAGE_TYPES.MARKETS_EXPANDED,
        reciever: MESSAGE_CLIENTS.BACKGROUND,
        sender: MESSAGE_CLIENTS.CONTENT
    }
    sendMessage(message);
}

async function onExpandMarketsEvent_Old() {
    const marketIDPREFIX = "cphBody_GridArrivalData_gvOrders_0_imgProductsShow_";
    var districtExpandBtn = document.getElementById("cphBody_GridArrivalData_imgOrdersShow_0")

    async function clickButton(button, time) {
        button.click()
        return new Promise((resolve) => {
            setTimeout(() => {
                resolve();
            }, time)
        })
    }

    await clickButton(districtExpandBtn, 500);
    let proceed = true;
    let counter = 0;
    while (proceed) {
        const elementId = `${marketIDPREFIX}${counter}`;
        console.log(counter, "Clicking button", elementId)
        let marketExpandButton = document.getElementById(elementId);
        if (!marketExpandButton) {
            proceed = false;
            console.log("Total markets is", counter);
            break;
        }
        await clickButton(marketExpandButton, 800);
        counter++;
    }
    console.log("------DONE---------, Download Now");

    let message = {
        type: MESSAGE_TYPES.MARKETS_EXPANDED,
        reciever: MESSAGE_CLIENTS.BACKGROUND,
        sender: MESSAGE_CLIENTS.CONTENT
    }
    sendMessage(message);
}

function sendPageLoadedEvent() {
    let commoditySelector = document.getElementById("ddlCommodity");
    let stateSelector = document.getElementById("ddlState");

    let data = {
        commodity: commoditySelector.value,
        state: stateSelector.value
    }

    let message = {
        type: MESSAGE_TYPES.PAGE_LOADED,
        reciever: MESSAGE_CLIENTS.BACKGROUND,
        sender: MESSAGE_CLIENTS.CONTENT,
        data,
    }

    sendMessage(message);
}

function clickExcelButton() {
    var excelButton = document.getElementById("cphBody_ButtonExcel");
    excelButton.click();
}

// BACKGROUND FUNCTIONS
function onPageLoadedEvent(pageData) {
    if (!CONTINUE)
        return;
    const { state, commodity } = pageData;
    let id = `${state}_${commodity}`;
    let p = PromiseMap.page_reloads.get(id);
    if (p) {
        p.resolve();
        PromiseMap.page_reloads.delete(id);
        console.log("Resolving page load promise", id);
    } else {
        console.log("Could not find page reload promise for", id);
        return;
    }
    let message = {
        type: MESSAGE_TYPES.EXPAND_MARKETS,
        reciever: MESSAGE_CLIENTS.CONTENT,
        sender: MESSAGE_CLIENTS.BACKGROUND,
    }
    sendMessage(message);;
}

function sendDownloadExcelEvent() {
    let message = {
        type: MESSAGE_TYPES.DOWNLOAD_EXCEL,
        reciever: MESSAGE_CLIENTS.CONTENT,
        sender: MESSAGE_CLIENTS.BACKGROUND,
    }

    sendMessage(message);;
}

async function sendReloadPageEvent(state, commodity, fromDate, toDate) {
    let data = {
        state,
        commodity,
        fromDate,
        toDate
    }
    let promise = createPromise();
    PromiseMap.page_reloads.set(`${state}_${commodity}`, promise);
    let message = {
        type: MESSAGE_TYPES.RELOAD_PAGE,
        reciever: MESSAGE_CLIENTS.CONTENT,
        sender: MESSAGE_CLIENTS.BACKGROUND,
        data
    }
    sendMessage(message);;
    return promise;
}

async function excelDownload(state, crop) {
    let p = createPromise();
    let id = `${state}_${crop}`;
    console.log("creating download promise for ", id)
    PromiseMap.downloads.set(id, p);
    return p;
}

// GLOBAL VARIABLES
var CURRENT_CROP = "";
var CURRENT_STATE = "";
var CONTINUE = false;
var PromiseMap = {
    "page_reloads": new Map(),
    "downloads": new Map()
}

function setupDownloadListeners() {
    let conflictAction = "overwrite";
    chrome.downloads.onDeterminingFilename.addListener((downloadItem, __suggest) => {
        if (!CONTINUE)
            return;
        console.log("Download Intercepted", downloadItem);
        if (!downloadItem.url.startsWith("https://agmarknet.gov.in")) {
            return;
        }
        function suggest(filename) {
            __suggest({
                filename: filename,
                conflictAction: conflictAction,
                conflict_action: conflictAction
            });
        }
        let state = CodeToStates[CURRENT_STATE];
        let crop = CodeToCrops[CURRENT_CROP];
        let filename = `${state}_${crop}.xls`;
        if (!filename)
            filename = "Arrival Report.xls"
        suggest(filename);
    });
    chrome.downloads.onChanged.addListener((change) => {
        console.log("download changed", change);
        let downloadState = change?.state?.current;
        if (!downloadState)
            return;
        let id = `${CURRENT_STATE}_${CURRENT_CROP}`;
        if (downloadState === "complete" || downloadState == "interrupted") {
            console.log(`File ${id} is complete or interrupted`, change.state);
            let p = PromiseMap.downloads.get(id);
            if (!p)
                return;
            p.resolve();
            PromiseMap.downloads.delete(id);
        }
    })
}

async function stopAutomation() {
    PromiseMap.page_reloads.clear();
    PromiseMap.downloads.clear();
    CURRENT_STATE = "";
    CURRENT_CROP = "";
    CONTINUE = false;
}

async function startAutomation(data) {
    CONTINUE = true;
    let crops = data.crops;
    console.log("starting automation", crops);
    if (!crops) {
        crops = [
            CropsToCode["Onion"]
        ]
    }
    // let states = [
    //     "Andhra Pradesh",
    //     // "Arunachal Pradesh"
    // ]
    let states = Object.keys(StatesToCode);
    let fromDate = "01-Jan-2010";
    let toDate = "31-Dec-2020";
    for (let crop of crops) {
        if (!CONTINUE)
            return;
        let i = 0;
        for (let state of states) {
            // if (i > 4)
            //     break;
            i++;
            state = StatesToCode[state];
            CURRENT_CROP = crop;
            CURRENT_STATE = state;
            await sendReloadPageEvent(state, crop, fromDate, toDate);
            console.log("Scheduling download");
            await excelDownload(state, crop);
            console.log(`${state}_${crop} downloaded successfully`);
        }
    }
    CONTINUE = false;
}
